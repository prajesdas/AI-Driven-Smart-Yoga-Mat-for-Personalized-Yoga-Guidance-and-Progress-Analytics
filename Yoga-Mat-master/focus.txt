FACE_DETECTION_MODEL = 0  # 0 for short-range, 1 for full-range
MIN_DETECTION_CONFIDENCE = 0.90  # Set minimum confidence to 90%
MIN_LANDMARK_CONFIDENCE = 0.5
MIN_PRESENCE_CONFIDENCE = 0.5
RECOGNITION_THRESHOLD = 0.75  # Adjust this value

# --- Configuration for Push-Up Counter ---
md_drawing = mp.solutions.drawing_utils
md_drawing_styles = mp.solutions.drawing_styles
md_pose = mp.solutions.pose
count = 0
position = None

# --- Initialize MediaPipe Face Detection ---
mp_face_detection = mp.solutions.face_detection
face_detection = mp_face_detection.FaceDetection(
    model_selection=FACE_DETECTION_MODEL,
    min_detection_confidence=MIN_DETECTION_CONFIDENCE
)

# --- Initialize Pose (Push-up counter) ---
cap = cv2.VideoCapture(0)

# --- Face Detection and Recognition Functions ---
def extract_features(face_landmarks):
    return np.random.rand(128)  # Simulated feature extraction

def compare_faces(features1, features2):
    return np.random.rand()  # Simulated face comparison

def recognize_face(image, known_faces):
    rgb_image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    results = face_detection.process(rgb_image)

    if results.detections:
        for detection in results.detections:
            if detection.score[0] >= MIN_DETECTION_CONFIDENCE:
                bboxC = detection.location_data.relative_bounding_box
                ih, iw, _ = image.shape
                bbox = int(bboxC.xmin * iw), int(bboxC.ymin * ih), \
                       int(bboxC.width * iw), int(bboxC.height * ih)

                cv2.rectangle(image, bbox, (0, 255, 0), 2)
                label = f"Face Detected: {(detection.score[0] * 100):.2f}%"
                highest_similarity = 0.0
                best_match = None

                if known_faces:  # Simulate matching if known faces are "enrolled"
                    first_name = list(known_faces.keys())[0]
                    label = f"Face Matched: {first_name} ({(detection.score[0] * 100):.2f}%)"
                    highest_similarity = 0.95  # High simulated similarity
                    best_match = first_name
                else:
                    label = f"Face Detected: {(detection.score[0] * 100):.2f}%"

                cv2.putText(image, label, (bbox[0], bbox[1] - 10),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 2)
                # We only process the first face that meets the confidence threshold
                break
    return image

# --- Push-Up Counter Functions ---
def calculate_angle(a, b, c):
    """Calculates the angle between three points."""
    radians = math.atan2(c[1] - b[1], c[0] - b[0]) - math.atan2(a[1] - b[1], a[0] - b[0])
    angle = math.degrees(radians) 
    angle = abs(angle)
    if angle > 180.0:
        angle = 360 - angle
    return angle

def smooth_angle(angle, previous_angle, alpha=0.2):
    """Smooths angle data."""
    if previous_angle is None:
        return angle
    return alpha * angle + (1 - alpha) * previous_angle

